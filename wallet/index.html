<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Гаманець - SCR</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239333ea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z'/%3e%3c/svg%3e">
    <script src="https://www.paypal.com/sdk/js?client-id=ASJIOL6y24xuwQiCC-a8RBkVypAp5VuYLf7cXEIzc4aLV5yYEXDVvellq-OGQQfZjkqJBZh1h0JqS9mU&currency=USD"></script>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- НОВА ФУНКЦІЯ: Скрипт для миттєвого застосування теми (запобігає мерехтінню) -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'light') {
                document.documentElement.classList.add('light-theme');
            }
        })();
    </script>

    <style>
        /* НОВА ФУНКЦІЯ: Змінні для темної та світлої теми */
        :root {
            /* Темна тема (за замовчуванням) */
            --primary-color: #9333ea;
            --primary-glow: rgba(147, 51, 234, 0.4);
            --danger-color: #ef4444;
            --bg-main: #020617;
            --bg-sidebar: rgba(12, 19, 34, 0.85);
            --bg-header: rgba(2, 6, 23, 0.7);
            --bg-card: rgba(15, 23, 42, 0.55);
            --bg-card-secondary: rgba(51, 65, 85, 0.4);
            --bg-card-secondary-hover: rgba(51, 65, 85, 0.7);
            --bg-overlay: rgba(0, 0, 0, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: rgba(51, 65, 85, 0.5);
            --border-hover: rgba(147, 51, 234, 0.6);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --sidebar-width-expanded: 260px;
            --sidebar-width-collapsed: 88px;
        }

        html.light-theme {
            /* Світла тема */
            --primary-color: #8b5cf6;
            --primary-glow: rgba(139, 92, 246, 0.3);
            --danger-color: #dc2626;
            --bg-main: #f1f5f9;
            --bg-sidebar: rgba(255, 255, 255, 0.8);
            --bg-header: rgba(255, 255, 255, 0.7);
            --bg-card: #ffffff;
            --bg-card-secondary: #e2e8f0;
            --bg-card-secondary-hover: #cbd5e1;
            --bg-overlay: rgba(2, 6, 23, 0.6);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --border-hover: #a78bfa;
            --shadow-color: rgba(45, 55, 72, 0.1);
        }

        *, ::after, ::before { box-sizing: border-box; }

        body, html {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .background-glow { /* ... без змін ... */ }
        @keyframes aurora-glow { /* ... без змін ... */ }

        .page-container { display: grid; grid-template-columns: var(--sidebar-width-expanded) 1fr; min-height: 100vh; transition: grid-template-columns 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        .sidebar { background-color: var(--bg-sidebar); backdrop-filter: blur(10px); border-right: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; position: fixed; left: 0; top: 0; height: 100%; width: var(--sidebar-width-expanded); z-index: 1000; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s; }
        .sidebar-header { /* ... без змін ... */ }
        .logo-icon { /* ... без змін ... */ }
        .logo-text { /* ... без змін ... */ }
        .nav-menu { /* ... без змін ... */ }
        .nav-item a { /* ... без змін ... */ }
        .nav-item a:hover { background-color: rgba(147, 51, 234, .07); color: var(--text-primary); }
        .nav-item.active a { /* ... без змін ... */ }
        .nav-icon, .nav-text { /* ... без змін ... */ }

        .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .footer-btn { background: none; border: none; width: 100%; display: flex; align-items: center; padding: .8rem 1rem; color: var(--text-secondary); font-size: 1rem; font-weight: 500; cursor: pointer; border-radius: 8px; margin-bottom: 0.5rem; transition: all 0.2s; }
        .footer-btn:hover { background-color: rgba(147, 51, 234, .07); color: var(--text-primary); }
        .collapse-btn svg { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        body.sidebar-collapsed .page-container { grid-template-columns: var(--sidebar-width-collapsed) 1fr; }
        body.sidebar-collapsed .sidebar { width: var(--sidebar-width-collapsed); }
        body.sidebar-collapsed .logo-text, body.sidebar-collapsed .nav-text { opacity: 0; width: 0; pointer-events: none; }
        body.sidebar-collapsed .nav-item a, body.sidebar-collapsed .footer-btn { justify-content: center; padding: 0.8rem; }
        body.sidebar-collapsed .nav-icon { margin-right: 0; }
        body.sidebar-collapsed .collapse-btn svg { transform: rotate(180deg); }

        .page-header { position: sticky; top: 0; grid-column: 2 / 3; display: flex; justify-content: space-between; align-items: center; padding: 1rem 2.5rem; height: 72px; z-index: 900; background-color: var(--bg-header); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        .page-header h1 { /* ... без змін ... */ }

        .main-content, .dashboard-grid, @keyframes content-fade-in { /* ... без змін ... */ }

        .balance-card { background-color: var(--bg-card); border: 1px solid var(--border-color); box-shadow: 0 8px 32px var(--shadow-color); /* ... решта без змін ... */ }
        .balance-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px var(--shadow-color), 0 0 60px -10px var(--primary-glow);
            /* ВИДАЛЕНО: обводка при наведенні */
        }
        .balance-title { /* ... без змін ... */ }
        .balance-amount {
            background: linear-gradient(120deg, var(--text-primary) 30%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            /* ... решта без змін ... */
        }
        .balance-amount .skeleton { /* ... без змін ... */ }
        .action-buttons, .btn { /* ... без змін ... */ }
        .btn-primary { /* ... без змін ... */ }
        .btn-secondary { background-color: var(--bg-card-secondary); color: var(--text-secondary); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: var(--bg-card-secondary-hover); color: var(--text-primary); border-color: var(--text-secondary); transform: translateY(-4px); }

        .modal-overlay { background-color: var(--bg-overlay); /* ... решта без змін ... */ }
        .modal-content { background-color: var(--bg-sidebar); border: 1px solid var(--border-color); box-shadow: 0 8px 32px var(--shadow-color); /* ... решта без змін ... */ }
        #amount-form input { background-color: var(--bg-main); /* ... решта без змін ... */ }

        /* НОВА ФУНКЦІЯ: Анімований бургер-меню */
        .sidebar-toggle { display: none; background: transparent; border: none; cursor: pointer; padding: 0.5rem; width: 44px; height: 44px; z-index: 1001; }
        .hamburger { position: relative; width: 24px; height: 20px; }
        .hamburger .line { position: absolute; left: 0; width: 100%; height: 2px; background-color: var(--text-primary); border-radius: 2px; transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        .hamburger .line-1 { top: 0; }
        .hamburger .line-2 { top: 9px; }
        .hamburger .line-3 { top: 18px; }

        body.sidebar-open .hamburger .line-1 { transform: translateY(9px) rotate(45deg); }
        body.sidebar-open .hamburger .line-2 { opacity: 0; }
        body.sidebar-open .hamburger .line-3 { transform: translateY(-9px) rotate(-45deg); }

        .overlay { background-color: rgba(2, 6, 23, 0.6); /* ... решта без змін ... */ }

        /* Перемикач теми */
        #theme-toggle-btn .icon { width: 24px; height: 24px; }
        html.light-theme #theme-toggle-btn .icon-moon { display: none; }
        html:not(.light-theme) #theme-toggle-btn .icon-sun { display: none; }
        
        @media (max-width: 992px) { /* ... без змін ... */ }
    </style>
</head>
<body>
    <div class="background-glow"></div>
    <div class="page-container">
        <aside class="sidebar">
            <a href="/wallet/" class="sidebar-header"><!-- ... --></a>
            <ul class="nav-menu"><!-- ... --></ul>
            <div class="sidebar-footer">
                <!-- НОВА ФУНКЦІЯ: Кнопка перемикання теми -->
                <button class="footer-btn" id="theme-toggle-btn" title="Змінити тему">
                    <span class="nav-icon">
                        <svg class="icon icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /></svg>
                        <svg class="icon icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" /></svg>
                    </span>
                    <span class="nav-text">Змінити тему</span>
                </button>
                <button class="footer-btn collapse-btn" id="sidebar-collapse-btn" title="Згорнути/Розгорнути меню">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>
                    <span class="nav-text">Згорнути</span>
                </button>
                <button class="footer-btn" id="logout-button" title="Вийти з акаунту">
                    <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></span>
                    <span class="nav-text">Вийти</span>
                </button>
            </div>
        </aside>

        <header class="page-header">
            <h1>Гаманець</h1>
            <!-- НОВА ФУНКЦІЯ: Оновлена розмітка для анімованого бургера -->
            <button class="sidebar-toggle">
                <div class="hamburger">
                    <span class="line line-1"></span>
                    <span class="line line-2"></span>
                    <span class="line line-3"></span>
                </div>
            </button>
        </header>

        <main class="main-content"><!-- ... Вміст main без змін --></main>
    </div>
    
    <div class="overlay"></div>
    <div class="modal-overlay" id="deposit-modal"><!-- ... Модальне вікно без змін --></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const user = netlifyIdentity.currentUser();
        if (!user) { window.location.replace('/'); return; }

        // --- Елементи UI ---
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const sidebarCollapseBtn = document.getElementById('sidebar-collapse-btn');
        const sidebarToggle = document.querySelector('.sidebar-toggle');
        const overlay = document.querySelector('.overlay');
        
        // --- НОВА ФУНКЦІЯ: Перемикання теми ---
        const handleThemeToggle = () => {
            const isLightTheme = document.documentElement.classList.toggle('light-theme');
            localStorage.setItem('theme', isLightTheme ? 'light' : 'dark');
        };
        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', handleThemeToggle);
        }

        // --- Згортання бічної панелі на ПК ---
        const handleSidebarCollapse = () => {
            document.body.classList.toggle('sidebar-collapsed');
            const isCollapsed = document.body.classList.contains('sidebar-collapsed');
            localStorage.setItem('sidebarState', isCollapsed ? 'collapsed' : 'expanded');
        };
        if (localStorage.getItem('sidebarState') === 'collapsed') {
            document.body.classList.add('sidebar-collapsed');
        }
        if (sidebarCollapseBtn) {
            sidebarCollapseBtn.addEventListener('click', handleSidebarCollapse);
        }

        // --- Мобільне меню ---
        const toggleMobileSidebar = () => document.body.classList.toggle('sidebar-open');
        sidebarToggle.addEventListener('click', toggleMobileSidebar);
        overlay.addEventListener('click', toggleMobileSidebar);

        // --- Решта логіки (без змін) ---
        const balanceAmountEl = document.querySelector('.balance-amount');
        const depositBtn = document.getElementById('deposit-btn');
        const depositModal = document.getElementById('deposit-modal');
        const modalCloseBtn = depositModal.querySelector('.modal-close-btn');
        const amountForm = depositModal.querySelector('#amount-form');
        const amountInput = depositModal.querySelector('#amount-input');
        const paymentStatus = depositModal.querySelector('#payment-status');
        const paypalContainer = depositModal.querySelector('#paypal-button-container');
        const logoutButton = document.getElementById('logout-button');

        const resetModalState = () => {
            depositModal.querySelector('#modal-step-1').classList.remove('hidden');
            depositModal.querySelector('#modal-step-2').classList.add('hidden');
            amountInput.value = '';
            paymentStatus.textContent = '';
            paypalContainer.innerHTML = '';
        };
        const openModal = () => { resetModalState(); depositModal.classList.add('visible'); };
        const closeModal = () => { depositModal.classList.remove('visible'); };
        depositBtn.addEventListener('click', openModal);
        modalCloseBtn.addEventListener('click', closeModal);
        depositModal.addEventListener('click', (e) => { if (e.target === depositModal) closeModal(); });

        const displayBalance = (balanceValue) => { balanceAmountEl.innerHTML = `<span>${(Number(balanceValue) || 0).toFixed(2)} SCR</span>`; };
        const loadBalance = async () => {
            try {
                await user.jwt(true); 
                const latestUser = netlifyIdentity.currentUser();
                displayBalance(latestUser?.user_metadata?.balance);
            } catch (error) {
                console.error("Не вдалося оновити дані користувача:", error);
                displayBalance(user?.user_metadata?.balance);
            }
        };
        loadBalance();

        amountForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = amountInput.value;
            if (amount && parseFloat(amount) >= 1) {
                depositModal.querySelector('#modal-step-1').classList.add('hidden');
                depositModal.querySelector('#modal-step-2').classList.remove('hidden');
                renderPayPalButtons(amount);
            } else {
                alert('Будь ласка, введіть суму, що дорівнює або більша за 1 USD.');
            }
        });

        const renderPayPalButtons = (amount) => {
            paypalContainer.innerHTML = '';
            paypal.Buttons({
                createOrder: (data, actions) => actions.order.create({ purchase_units: [{ amount: { value: amount, currency_code: 'USD' } }] }),
                onApprove: async (data, actions) => {
                    paymentStatus.textContent = 'Перевірка платежу...';
                    try {
                        const response = await fetch('/.netlify/functions/update-balance', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${user.token.access_token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ orderID: data.orderID })
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error || 'Помилка перевірки платежу.');
                        paymentStatus.textContent = `Платіж успішний! Оновлюємо баланс...`;
                        const currentUser = netlifyIdentity.currentUser();
                        const currentBalance = Number(currentUser.user_metadata?.balance) || 0;
                        const newBalance = currentBalance + result.amountPaid;
                        const updatedUser = await currentUser.update({ data: { balance: newBalance } });
                        paymentStatus.textContent = `Баланс успішно поповнено!`;
                        displayBalance(updatedUser.user_metadata.balance);
                        setTimeout(closeModal, 2500);
                    } catch (err) {
                        console.error('Помилка обробки платежу:', err);
                        paymentStatus.textContent = `Помилка: ${err.message}`;
                    }
                },
                onError: (err) => {
                    console.error('Помилка кнопок PayPal:', err);
                    paymentStatus.textContent = 'Виникла помилка під час ініціалізації оплати.';
                }
            }).render(paypalContainer);
        };

        logoutButton.addEventListener('click', () => netlifyIdentity.logout());
        netlifyIdentity.on('logout', () => window.location.replace('/'));
    });
    </script>
</body>
</html>
